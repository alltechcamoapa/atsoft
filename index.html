<!DOCTYPE html>
<html lang="es" data-theme="light">

<head>
  <meta charset="UTF-8">
  <!-- PWA Viewport - Full screen optimized -->
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

  <!-- SEO & Description -->
  <meta name="description"
    content="ALLTECH - Sistema de Gesti√≥n Empresarial. Gesti√≥n de clientes, contratos, visitas t√©cnicas y m√°s.">
  <meta name="author" content="ALLTECH">
  <meta name="keywords" content="gesti√≥n, clientes, contratos, ALLTECH">

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#1a73e8">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ALLTECH">
  <meta name="application-name" content="ALLTECH">
  <meta name="msapplication-TileColor" content="#1a73e8">
  <meta name="format-detection" content="telephone=no">

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">

  <title>ALLTECH</title>

  <!-- Favicon - Logo de la empresa -->
  <link rel="icon" type="image/png" sizes="192x192" href="assets/icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="assets/icons/icon-512x512.png">

  <!-- Apple Touch Icon -->
  <link rel="apple-touch-icon" sizes="192x192" href="assets/icons/icon-192x192.png">

  <!-- Google Fonts - Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Stylesheets -->
  <link rel="stylesheet" href="css/tokens.css">
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/layout.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/modal.css">
  <link rel="stylesheet" href="css/forms.css">
  <link rel="stylesheet" href="css/modules.css">
  <link rel="stylesheet" href="css/modules-tabs.css">
  <link rel="stylesheet" href="css/permissions.css">

  <link rel="stylesheet" href="css/report-editor.css">
  <link rel="stylesheet" href="css/responsive-optimization.css">
  <link rel="stylesheet" href="css/welcome-animations.css">
  <link rel="stylesheet" href="css/pwa.css">
  <link rel="stylesheet" href="css/animations.css">
  <link rel="stylesheet" href="css/notifications.css">
  <link rel="stylesheet" href="css/mobile-enhancements.css">

  <!-- Supabase Client Library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* Loading screen */
    .loading-screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-primary);
      z-index: 9999;
      transition: opacity 0.3s ease;
    }

    .loading-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--border-color);
      border-top-color: var(--color-primary-500);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Hide app until loaded */
    #app:empty::before {
      content: '';
      display: block;
      width: 100%;
      height: 100vh;
    }

    /* Mobile menu button visibility */
    .header__menu-btn {
      display: none;
    }

    @media (max-width: 1024px) {
      .header__menu-btn {
        display: flex;
      }
    }
  </style>
</head>

<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-spinner"></div>
  </div>

  <!-- App Container -->
  <div id="app" class="app"></div>


  <!-- Device Detection (must load first) -->
  <script src="js/device-detection.js"></script>

  <!-- Services -->
  <script src="js/services/state.js"></script>

  <!-- Supabase Configuration & Service -->
  <script src="js/config/supabase.js"></script>
  <script src="js/services/supabase-data-service.js"></script>

  <!-- Legacy Services (fallback) -->
  <script src="js/services/data-service.js"></script>
  <script src="js/services/log-service.js"></script>
  <script src="js/services/whatsapp-service.js"></script>
  <script src="js/services/email-service.js"></script>
  <script src="js/icons.js"></script>

  <!-- Modules -->
  <script src="js/modules/login-module.js"></script>
  <script src="js/modules/clientes.js"></script>
  <script src="js/modules/contratos.js"></script>
  <script src="js/modules/contract-editor-module.js"></script>
  <script src="js/modules/visitas.js"></script>
  <script src="js/modules/equipos.js"></script>
  <script src="js/modules/software.js"></script>
  <script src="js/modules/calendario.js"></script>
  <script src="js/modules/reportes.js"></script>
  <script src="js/modules/config-module.js"></script>
  <script src="js/modules/productos.js"></script>
  <script src="js/modules/proformas.js"></script>
  <script src="js/modules/pedidos.js"></script>
  <script src="js/modules/prestaciones.js"></script>
  <script src="js/modules/gestion-tecnicos.js"></script>
  <script src="js/modules/report-editor.js"></script>
  <script src="js/welcome-module.js"></script>

  <!-- Session Sync -->
  <script src="js/services/session-sync.js"></script>
  <!-- Notification Service -->
  <script src="js/services/notification-service.js"></script>
  <!-- PWA Manager -->
  <script src="js/pwa-manager.js"></script>
  <!-- Main App -->
  <script src="js/app.js"></script>

  <script>
    // Initialize with session sync
    document.addEventListener('DOMContentLoaded', async () => {
      // console.log('üöÄ ALLTECH - Iniciando...');

      try {
        // IMPORTANT: State.init() MUST run first to load localStorage data
        State.init();

        // Now sync can correctly verify state vs Supabase session
        await SessionSync.checkAndSync();

        // Cargar datos de negocio desde Supabase (Pre-fetching)
        if (State.isLoggedIn()) {
          // console.log('‚òÅÔ∏è Iniciando carga de datos...');
          const success = await DataService.init();
          if (!success) console.warn('‚ö†Ô∏è DataService inici√≥ con datos parciales o vac√≠os');

          // Initialize notifications AFTER data is loaded
          if (typeof NotificationService !== 'undefined') {
            NotificationService.init();
          }
        }

        // Initialize the app
        App.init();

        // console.log('‚úÖ ALLTECH - Inicializaci√≥n completa');
      } catch (error) {
        console.error('‚ùå Error cr√≠tico en inicializaci√≥n:', error);
        // Even on error, try to render something
        if (typeof App !== 'undefined' && App.render) {
          State.logout();
          App.render();
        }
      }
    });

    // Hide loading screen - always hide after timeout even if there's an issue
    window.addEventListener('load', () => {
      setTimeout(() => {
        const loader = document.getElementById('loadingScreen');
        if (loader) {
          loader.classList.add('hidden');
        }
      }, 500);
    });

    // Fallback: hide loading screen after 5 seconds no matter what
    setTimeout(() => {
      const loader = document.getElementById('loadingScreen');
      if (loader && !loader.classList.contains('hidden')) {
        console.warn('‚ö†Ô∏è Forzando ocultar loading screen por timeout');
        loader.classList.add('hidden');
      }
    }, 5000);
  </script>
</body>

</html>