<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - ALLTECH Login</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #000;
            color: #fff;
        }

        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: #1a1a2e;
            padding: 20px;
            border-radius: 8px;
        }

        .test-item {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: #16213e;
        }

        .success {
            border-left: 4px solid #10b981;
        }

        .error {
            border-left: 4px solid #dc2626;
        }

        button {
            padding: 10px 20px;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        pre {
            background: #0a0a0a;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <div class="test-container">
        <h1>üîç Diagn√≥stico ALLTECH Support</h1>
        <p>Esta p√°gina verifica que todos los componentes est√©n cargados correctamente.</p>

        <div id="results"></div>

        <button onclick="runTests()">üîÑ Ejecutar Tests</button>
        <button onclick="testLogin()">üîê Test Login</button>
    </div>

    <!-- Cargar scripts en el mismo orden que index.html -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/services/state.js"></script>
    <script src="js/config/supabase.js"></script>
    <script src="js/services/supabase-data-service.js"></script>
    <script src="js/modules/login-module.js"></script>
    <script src="js/icons.js"></script>

    <script>
        function addResult(name, passed, details = '') {
            const div = document.createElement('div');
            div.className = `test-item ${passed ? 'success' : 'error'}`;
            div.innerHTML = `
                <strong>${passed ? '‚úÖ' : '‚ùå'} ${name}</strong>
                ${details ? `<pre>${details}</pre>` : ''}
            `;
            document.getElementById('results').appendChild(div);
        }

        function runTests() {
            document.getElementById('results').innerHTML = '<h2>Resultados:</h2>';

            // Test 1: Supabase library
            const supabaseLoaded = typeof supabase !== 'undefined';
            addResult('Supabase Library', supabaseLoaded,
                supabaseLoaded ? 'Versi√≥n: ' + (supabase.VERSION || 'unknown') : 'NO CARGADO');

            // Test 2: State service
            const stateLoaded = typeof State !== 'undefined';
            addResult('State Service', stateLoaded,
                stateLoaded ? 'M√©todos: ' + Object.keys(State).join(', ') : 'NO CARGADO');

            // Test 3: Supabase config
            const configLoaded = typeof getSupabaseClient === 'function';
            addResult('Supabase Config', configLoaded);

            if (configLoaded) {
                const client = getSupabaseClient();
                addResult('Supabase Client', !!client,
                    client ? 'Cliente inicializado correctamente' : 'Error al inicializar');
            }

            // Test 4: Auth functions
            const authFuncs = {
                signIn: typeof signIn === 'function',
                signOut: typeof signOut === 'function',
                isAuthenticated: typeof isAuthenticated === 'function',
                getCurrentProfile: typeof getCurrentProfile === 'function'
            };
            addResult('Auth Functions', Object.values(authFuncs).every(v => v),
                JSON.stringify(authFuncs, null, 2));

            // Test 5: SupabaseDataService
            const dataServiceLoaded = typeof SupabaseDataService !== 'undefined';
            addResult('Supabase Data Service', dataServiceLoaded,
                dataServiceLoaded ? 'M√©todos: ' + Object.keys(SupabaseDataService).slice(0, 5).join(', ') + '...' : 'NO CARGADO');

            // Test 6: LoginModule
            const loginModuleLoaded = typeof LoginModule !== 'undefined';
            addResult('Login Module', loginModuleLoaded,
                loginModuleLoaded ? 'Tiene render: ' + (typeof LoginModule.render === 'function') : 'NO CARGADO');

            // Test 7: Icons
            const iconsLoaded = typeof Icons !== 'undefined';
            addResult('Icons Module', iconsLoaded,
                iconsLoaded ? 'Icons disponibles: ' + Object.keys(Icons).length : 'NO CARGADO');

            // Summary
            const total = 7;
            const passed = [
                supabaseLoaded,
                stateLoaded,
                configLoaded,
                Object.values(authFuncs).every(v => v),
                dataServiceLoaded,
                loginModuleLoaded,
                iconsLoaded
            ].filter(Boolean).length;

            addResult('RESUMEN', passed === total,
                `${passed}/${total} tests pasados`);
        }

        async function testLogin() {
            const email = prompt('Email de prueba:', 'admin@alltechsupport.com');
            const password = prompt('Password:');

            if (!email || !password) {
                alert('Cancelado');
                return;
            }

            try {
                console.log('Probando login...');
                const result = await signIn(email, password);

                if (result.success) {
                    alert('‚úÖ Login exitoso!');
                    const profile = await getCurrentProfile();
                    console.log('Perfil:', profile);
                    addResult('Test Login', true,
                        `Usuario: ${profile.username}\nNombre: ${profile.full_name}\nRol: ${profile.role_name}`);
                } else {
                    alert('‚ùå Login fall√≥: ' + result.error);
                    addResult('Test Login', false, result.error);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
                addResult('Test Login', false, error.message);
                console.error(error);
            }
        }

        // Auto-run tests on load
        window.addEventListener('load', () => {
            setTimeout(runTests, 500);
        });
    </script>
</body>

</html>